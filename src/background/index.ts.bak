console.log("StickyMonkey Background Script Loaded");

// Initialize userscripts environment
chrome.runtime.onInstalled.addListener(async () => {
  console.log("StickyMonkey installed - Initializing...");

  // Enable userScripts API if available
  if (chrome.userScripts) {
    try {
      // Configure the world to allow messaging if needed
      await chrome.userScripts.configureWorld({
        messaging: true
      });
      console.log("UserScripts world configured");

      // Unregister existing scripts to avoid duplicates during dev
      // In a real app we would manage this better
      const existingScripts = await chrome.userScripts.getScripts();
      if (existingScripts.length > 0) {
        const ids = existingScripts.map(s => s.id);
        await chrome.userScripts.unregister({ ids });
        console.log("Unregistered existing scripts:", ids);
      }

      // Register a test script
      const testScriptId = "test-script-1";
      const code = `
            console.log("%c üêí StickyMonkey: Hello from UserScript! ", "background: #10b981; color: white; font-size: 12px; padding: 4px; border-radius: 4px;");
            
            // Example specific to the user's environment if needed
            if (window.location.hostname === 'example.com') {
                document.body.style.border = "5px solid #10b981";
            }
          `;

      await chrome.userScripts.register([{
        id: testScriptId,
        matches: ["<all_urls>"],
        js: [{ code }],
        runAt: 'document_end',
        world: 'USER_SCRIPT'
      }]);

      console.log(`Test script '${testScriptId}' registered successfully`);

    } catch (err) {
      console.error("Failed to initialize user scripts:", err);
    }
  } else {
    console.error("chrome.userScripts API is not available. Make sure you are using Chrome 120+ and have the 'userScripts' permission.");
  }
});
